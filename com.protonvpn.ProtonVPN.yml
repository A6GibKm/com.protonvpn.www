# yaml-language-server: $schema=https://raw.githubusercontent.com/flatpak/flatpak-builder/main/data/flatpak-manifest.schema.json

app-id: com.protonvpn.ProtonVPN
runtime: org.gnome.Platform
runtime-version: '43'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: protonvpn
separate-locales: false
finish-args:
  - --device=dri
  - --share=ipc
  - --share=network
  - --socket=wayland
  - --socket=fallback-x11
  - --talk-name=org.freedesktop.Notifications
  # Disable it before it's allowlisted
  # - --talk-name=org.freedesktop.Flatpak
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-run/gvfsd
  - --system-talk-name=org.freedesktop.NetworkManager

modules:
  - shared-modules/libsecret/libsecret.json
  - shared-modules/intltool/intltool-0.51.json

  # Python dependencies required to build things
  # https://github.com/flathub/org.thonny.Thonny/blob/2f10b0123b1df4111c4c4fb3277fdebab56c7e73/org.thonny.Thonny.yaml#L75-L234
  - name: python3-toml
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "toml" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
        sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
        x-checker-data:
          type: pypi
          name: toml
  - name: python3-flit_core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "flit_core" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/10/e5/be08751d07b30889af130cec20955c987a74380a10058e6e8856e4010afc/flit_core-3.8.0.tar.gz
        sha256: b305b30c99526df5e63d6022dd2310a0a941a187bd3884f4c8ef0418df6c39f3
        x-checker-data:
          type: pypi
          name: flit_core
  - name: python3-poetry-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "poetry-core" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/01/10/dec07a2308b68c5b89432dcc80b0dd8882e45e4c90b5851552bb22247ca7/poetry_core-1.5.2.tar.gz
        sha256: c6556c3b1ec5b8668e6ef5a4494726bc41d31907339425e194e78a6178436c14
        x-checker-data:
          type: pypi
          name: poetry-core
  - name: python3-setuptools_scm
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_scm" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/6c/10/a7d0fa5baea8fe7b50f448ab742f26f52b80bfca85ac2be9d35cdd9a3246/pyparsing-3.0.9-py3-none-any.whl
        sha256: 5026bae9a10eeaefb61dab2f09052b9f4307d44aee4eda64b309723d8d206bbc
        x-checker-data:
          name: pyparsing
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/31/25/5abcd82372d3d4a3932e1fa8c3dbf9efac10cc7c0d16e78467460571b404/typing_extensions-4.5.0-py3-none-any.whl
        sha256: fb33085c39dd998ac16d1431ebc293a8b3eedd00fd4a32de0ff79002c19511b4
        x-checker-data:
          name: typing_extensions
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/97/75/10a9ebee3fd790d20926a90a2547f0bf78f371b2f13aa822c759680ca7b9/tomli-2.0.1-py3-none-any.whl
        sha256: 939de3e7a6161af0c887ef91b7d41a53e7c5a1ca976325f429cb46ea9bc30ecc
        x-checker-data:
          name: tomli
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/ed/35/a31aed2993e398f6b09a790a181a7927eb14610ee8bbf02dc14d31677f1c/packaging-23.0-py3-none-any.whl
        sha256: 714ac14496c3e68c99c29b00845f7a2b85f3bb6f1078fd9f72fd20f0570002b2
        x-checker-data:
          name: packaging
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/1d/66/8f42c941be949ef2b22fe905d850c794e7c170a526023612aad5f3a121ad/setuptools_scm-7.1.0-py3-none-any.whl
        sha256: 73988b6d848709e2af142aa48c986ea29592bbcfca5375678064708205253d8e
        x-checker-data:
          name: setuptools_scm
          packagetype: bdist_wheel
          type: pypi
  - name: python3-typing_extensions
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "typing_extensions" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/31/25/5abcd82372d3d4a3932e1fa8c3dbf9efac10cc7c0d16e78467460571b404/typing_extensions-4.5.0-py3-none-any.whl
        sha256: fb33085c39dd998ac16d1431ebc293a8b3eedd00fd4a32de0ff79002c19511b4
        x-checker-data:
          type: pypi
          name: typing_extensions
          packagetype: bdist_wheel
  - name: python3-setuptools_rust
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_rust" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/7d/31/f2289ce78b9b473d582568c234e104d2a342fd658cc288a7553d83bb8595/semantic_version-2.10.0.tar.gz
        sha256: bdabb6d336998cbb378d4b9db3a4b56a1e3235701dc05ea2690d9a997ed5041c
        x-checker-data:
          type: pypi
          name: semantic_version
      - type: file
        url: https://files.pythonhosted.org/packages/99/db/e4ecb483ffa194d632ed44bda32cb740e564789fed7e56c2be8e2a0e2aa6/setuptools-rust-1.5.2.tar.gz
        sha256: d8daccb14dc0eae1b6b6eb3ecef79675bd37b4065369f79c35393dd5c55652c7
        x-checker-data:
          type: pypi
          name: setuptools-rust

  # The bcrypt Python library is handled specially since it has Rust code and dependencies.
  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-bcrypt
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-bcrypt/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "bcrypt" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/8c/ae/3af7d006aacf513975fd1948a6b4d6f8b4a307f8a244e1a3d3774b297aad/bcrypt-4.0.1.tar.gz
        sha256: 27d375903ac8261cfe4047f6709d16f7d18d39b1ec92aaf72af989552a650ebd
      # The Cargo sources should be updated whenever bcrypt is updated.
      - bcrypt-cargo-sources.json

  - name: dbus-python
    buildsystem: autotools
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.3.2.tar.gz
        sha256: ad67819308618b5069537be237f8e68ca1c7fcc95ee4a121fe6845b1418248f8
        x-checker-data:
          type: anitya
          project-id: 402
          url-template: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-$version.tar.gz

  - name: libndp
    buildsystem: autotools
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://github.com/jpirko/libndp/archive/v1.8.tar.gz
        sha256: c3ea76e253def89869651686a827da75b56896fe94fabd87d8c14b1d4588fd05
        x-checker-data:
          type: anitya
          project-id: 14944
          stable-only: true
          url-template: https://github.com/jpirko/libndp/archive/v$version.tar.gz

  # https://github.com/flathub/org.gnome.NetworkDisplays/blob/5a3369d04e32ccd092e42463de5171f473a8601d/org.gnome.NetworkDisplays.json#LL97C11-L138C11
  - name: polkit
    config-opts:
      - --disable-polkitd
      - --disable-man-pages
      - --disable-introspection
      - --disable-examples
      - --disable-gtk-doc
      - --disable-libelogind
      - --disable-libsystemd-login
      - --with-systemdsystemunitdir=no
      - --with-authdb=dummy
      - --with-authfw=none
    rm-configure: true
    cleanup:
      - /bin/*
      - /etc/pam.d
      - /etc/dbus-1
      - /share/dbus-1/system-services/*
      - /share/polkit-1
      - /lib/polkit-1
      - /include
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/polkit/releases/polkit-0.120.tar.gz
        sha256: ee7a599a853117bf273548725719fa92fabd2f136915c7a4906cee98567aee03
        x-checker-data:
          type: anitya
          project-id: 3682
          stable-only: true
          url-template: https://gitlab.freedesktop.org/polkit/polkit/-/archive/$version/polkit-$version.tar.gz
      - type: patch
        path: patches/polkit/polkit-build-Add-option-to-build-without-polkitd.patch
      - type: file
        path: files/polkit/autogen.sh
        dest-filename: autogen.sh

  # https://github.com/flathub/org.gnome.NetworkDisplays/blob/5a3369d04e32ccd092e42463de5171f473a8601d/org.gnome.NetworkDisplays.json#LL177C11-L230C11
  - name: NetworkManager
    buildsystem: meson
    build-options:
      cflags: -ltinfo
      cxxflags: -ltinfo
    config-opts:
      - -Dsystemdsystemunitdir=no
      - -Ddbus_conf_dir=/app/etc/dbus-1/system.d
      - -Diptables=/usr/bin/true
      - -Ddnsmasq=/usr/bin/true
      - -Dsession_tracking=no
      - -Dselinux=false
      - -Dsystemd_journal=false
      - -Dlibaudit=no
      - -Dwext=false
      - -Dwifi=true
      - -Dppp=false
      - -Dmodem_manager=false
      - -Dovs=false
      - -Dnmcli=false
      - -Dnmtui=false
      # We need introspection
      - -Dintrospection=true
      - -Dvapi=false
      - -Ddocs=false
      - -Dtests=no
      - -Dfirewalld_zone=false
      - -Dlibpsl=false
      - -Dqt=false
    cleanup:
      - /bin
      - /etc
      - /include
      - /lib/pkgconfig
      - /libexec
      - /sbin
      - /var
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/NetworkManager/NetworkManager.git
        tag: 1.42.4
        commit: a17d50be63958da590a46ba84032265d78636106
        x-checker-data:
          type: anitya
          project-id: 21197
          stable-only: true
          tag-template: $version

  # https://github.com/flathub/com.github.jkotra.eovpn/blob/670f19e2aee1c9559fbe4eed904e35500843ae88/com.github.jkotra.eovpn.yml#L133C17-L151
  - name: libnma
    buildsystem: meson
    config-opts:
      - -Dmobile_broadband_provider_info=false
      - -Dgtk_doc=false
      - -Dintrospection=false
      - -Dvapi=false
    sources:
      - type: git
        url: https://gitlab.gnome.org/GNOME/libnma.git
        tag: 1.10.6
        x-checker-data:
          type: anitya
          project-id: 230112
          stable-only: true
          tag-template: $version

        commit: 3e324b69d0d74c8693fb58b9ee66efe0bad6cb34
  - name: NetworkManager-openvpn
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/NetworkManager/NetworkManager-openvpn.git
        tag: 1.10.2
        x-checker-data:
          type: anitya
          project-id: 69977
          stable-only: true
          tag-template: $version

        commit: ae9575dd07cc2d2d51ec8d0297823e07017cb6e6
  - name: proton-python-client
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation

    sources:
      - type: git
        url: https://github.com/ProtonMail/proton-python-client
        commit: 547abc8fc9a58f2d1076e9a559e12ede0d50f47e
        tag: 0.7.1
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ProtonMail/proton-python-client/releases/latest
          tag-query: .tag_name
          version-query: .tag_name
          timestamp-query: .published_at

      - type: file
        url: https://files.pythonhosted.org/packages/8c/ae/3af7d006aacf513975fd1948a6b4d6f8b4a307f8a244e1a3d3774b297aad/bcrypt-4.0.1.tar.gz
        sha256: 27d375903ac8261cfe4047f6709d16f7d18d39b1ec92aaf72af989552a650ebd
        x-checker-data:
          name: bcrypt
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/71/4c/3db2b8021bd6f2f0ceb0e088d6b2d49147671f25832fb17970e9b583d742/certifi-2022.12.7-py3-none-any.whl
        sha256: 4ad3232f5e926d6718ec31cfc1fcadfde020920e278684144551c91769c7bc18
        x-checker-data:
          name: certifi
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/2b/a8/050ab4f0c3d4c1b8aaa805f70e26e84d0e27004907c5b8ecc1d31815f92a/cffi-1.15.1.tar.gz
        sha256: d400bfb9a37b1351253cb402671cea7e89bdecc294e8016a707f6d1d8ac934f9
        x-checker-data:
          name: cffi
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/ff/d7/8d757f8bd45be079d76309248845a04f09619a7b17d6dfc8c9ff6433cac2/charset-normalizer-3.1.0.tar.gz
        sha256: 34e0a2f9c370eb95597aae63bf85eb5e96826d81e3dcf88b8886012906f509b5
        x-checker-data:
          name: charset-normalizer
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/fc/34/3030de6f1370931b9dbb4dad48f6ab1015ab1d32447850b9fc94e60097be/idna-3.4-py3-none-any.whl
        sha256: 90b77e79eaa3eba6de819a0c442c0b4ceefc341a7a2ab77d7562bf49f425c5c2
        x-checker-data:
          name: idna
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/73/00/b78f9fae05bb1633f7209aa394fa0c3563ef760ab7f47ac37768bf4e4d78/pyOpenSSL-23.0.0-py3-none-any.whl
        sha256: df5fc28af899e74e19fccb5510df423581047e10ab6f1f4ba1763ff5fde844c0
        x-checker-data:
          name: pyOpenSSL
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/62/d5/5f610ebe421e85889f2e55e33b7f9a6795bd982198517d912eb1c76e1a53/pycparser-2.21-py2.py3-none-any.whl
        sha256: 8ee45429555515e1f6b185e78100aea234072576aa43ab53aefcae078162fca9
        x-checker-data:
          name: pycparser
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/83/e8/44c05b10888c907e8e327f17f257655a25a3ebe44772b77ef87b5fb336c2/python_gnupg-0.5.0-py2.py3-none-any.whl
        sha256: 345723a03e67b82aba0ea8ae2328b2e4a3906fbe2c18c4082285c3b01068f270
        x-checker-data:
          name: python_gnupg
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/d2/f4/274d1dbe96b41cf4e0efb70cbced278ffd61b5c7bb70338b62af94ccb25b/requests-2.28.2-py3-none-any.whl
        sha256: 64299f4909223da747622c030b781c0d7811e359c37124b4bd368fb8c6518baa
        x-checker-data:
          name: requests
          packagetype: bdist_wheel
          type: pypi
      - type: file
        url: https://files.pythonhosted.org/packages/7b/f5/890a0baca17a61c1f92f72b81d3c31523c99bec609e60c292ea55b387ae8/urllib3-1.26.15-py2.py3-none-any.whl
        sha256: aa751d169e23c7479ce47a0cb0da579e3ede798f994f5816a74e4f4500dcea42
        x-checker-data:
          name: urllib3
          packagetype: bdist_wheel
          type: pypi

  - name: python3-protonvpn-nm-lib
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      - pip-resources.python3-protonvpn-nm-lib.json
    sources:
      - type: git
        url: https://github.com/ProtonVPN/protonvpn-nm-lib
        commit: cad0f6700696486fda18ded09abf9e7d7fd212d1
        tag: 3.14.0
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ProtonVPN/protonvpn-nm-lib/releases/latest
          tag-query: .tag_name
          version-query: .tag_name
          timestamp-query: .published_at
      - type: patch
        path: patches/protonvpn-nm-lib/fix-version-comparison.patch
      - type: patch
        path: patches/protonvpn-nm-lib/make-subprocess-wrapper-flatpak-aware.patch

  - name: protonvpn-cli
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # Generated with flatpak-pip-generator --yaml --checker-data pythondialog --output pip-resources.protonvpn-cli --runtime org.gnome.Sdk//43
      - name: python3-pythondialog
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "pythondialog" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/69/f0/b3c431610753aa5687384e67cb92fbc2d531eb86f1ce32a8cb9735f9b0b7/pythondialog-3.5.3-py3-none-any.whl
            sha256: b9ac084a1ba5db75242ef623ea6a770f0e74aa634869151be15a2d1c50daaab2
            x-checker-data:
              name: pythondialog
              packagetype: bdist_wheel
              type: pypi

    sources:
      - type: git
        url: https://github.com/ProtonVPN/linux-cli
        commit: 680fe8b9715529a28bdb1478c85929b99a7e00ef
        tag: 3.13.0
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ProtonVPN/linux-cli/releases/latest
          tag-query: .tag_name
          version-query: .tag_name
          timestamp-query: .published_at

  - name: protonvpn-gui
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation

      - desktop-file-edit --set-icon ${FLATPAK_ID} --set-key Exec --set-value 'protonvpn
        %u' protonvpn.desktop
      - install -Dm644 protonvpn.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 logo.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 com.protonvpn.ProtonVPN.metainfo.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
    modules:
      - name: python3-psutil
        buildsystem: simple
        build-commands:
          - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST}
            psutil
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/c6/c1/beed5e4eaa1345901b595048fab1c85aee647ea0fc02d9e8bf9aceb81078/psutil-5.6.2.tar.gz
            sha256: 828e1c3ca6756c54ac00f1427fdac8b12e21b8a068c3bb9b631a1734cada25ed
    sources:
      - type: git
        url: https://github.com/ProtonVPN/linux-app
        tag: 1.12.0
        commit: 776b1545a7acced44334f89a19e6f8acfc50c6d3
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ProtonVPN/linux-app/releases/latest
          tag-query: .tag_name
          version-query: .tag_name
          timestamp-query: .published_at

      - type: patch
        path: patches/protonvpn-gui/webkit-version.patch
      - type: patch
        path: patches/protonvpn-gui/application-id.patch

      - type: file
        path: logo.svg
